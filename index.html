<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EbookReferral dApp</title>
</head>
<body>
    <button id="connectBtn">Connect Wallet</button>
    <span id="walletStatus">Not connected</span>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
    <script>
        // --- Connect Wallet Function ---
        async function connectWallet() {
            if (!window.ethereum) {
                alert("MetaMask not detected. Please install MetaMask!");
                console.log("MetaMask not detected");
                return null;
            }

            try {
                // Check kung may existing connection
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    console.log("Already connected:", accounts[0]);
                    document.getElementById("walletStatus").innerText = `Connected: ${accounts[0]}`;
                    alert(`Already connected: ${accounts[0]}`); // monitoring popup
                    return accounts[0];
                } else {
                    // Trigger connect popup
                    const newAccounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    console.log("Connected:", newAccounts[0]);
                    document.getElementById("walletStatus").innerText = `Connected: ${newAccounts[0]}`;
                    alert(`Connected: ${newAccounts[0]}`); // monitoring popup
                    return newAccounts[0];
                }
            } catch (err) {
                console.error("Wallet connection rejected or error:", err);
                alert("Wallet connection rejected or error"); // monitoring popup
                return null;
            }
        }

        // --- Event Listener for account changes ---
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    console.log("Disconnected");
                    document.getElementById("walletStatus").innerText = "Disconnected";
                    alert("Wallet disconnected"); // monitoring popup
                } else {
                    console.log("Switched to", accounts[0]);
                    document.getElementById("walletStatus").innerText = `Connected: ${accounts[0]}`;
                    alert(`Switched to: ${accounts[0]}`); // monitoring popup
                }
            });
        }

        // --- Button click handler ---
        document.getElementById("connectBtn").addEventListener("click", async () => {
            await connectWallet();
        });

        // Optional: automatic check sa page load
        window.addEventListener('load', async () => {
            await connectWallet();
        });
    </script>
</body>
</html>
